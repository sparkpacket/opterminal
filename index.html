<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>sparkpacket's chat program</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
body { margin:0; font-family:monospace; background:#000; color:#0f0; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
#users { flex:0 0 auto; padding:10px; border-bottom:1px solid #0f0; font-size:12px; background:#000; }
#userlist { display:block; list-style:none; padding:0; margin:0; }
#chat { flex:1 1 auto; overflow-y:auto; padding:10px; border-bottom:1px solid #0f0; }
#input-container { flex:0 0 auto; position:relative; background:#000; border-top:1px solid #0f0; padding:5px; }
#privacy-note { position:absolute; top:-18px; right:10px; font-size:12px; color:#888; padding:2px 6px; pointer-events:none; transition:all 0.3s ease; }
#privacy-note.shrink { opacity:0.5; transform:scale(0.85); }
#input { width:100%; padding:10px; background:#000; color:#0f0; border:none; font-family:monospace; font-size:14px; }
.system { color:gray; font-style:italic; }
.message { margin-bottom:5px; }
.username { font-weight:bold; }
.self { color:red !important; }
#discord-note { position:fixed; top:10px; right:10px; background-color:#2b2b2b; color:white; padding:6px 10px; border-radius:4px; font-size:13px; z-index:9999; box-shadow:0 0 5px rgba(0,0,0,0.5); }
#discord-note a { color:#7289da; text-decoration:none; }
#discord-note a:hover { text-decoration:underline; }
</style>
</head>
<body>
<div id="users"><ul id="userlist"></ul></div>
<div id="chat"></div>
<div id="input-container">
  <div id="privacy-note">This site uses localStorage (cookies) to store information.</div>
  <input id="input" type="text" placeholder="Type a message..." autofocus autocomplete="off">
</div>
<script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
<script>
const ROOM_ID = 'YlACLLtfd8xkDp0D';
let username = localStorage.getItem('username') || 'unregistered';
let color = localStorage.getItem('color') || '#0f0';
let font = localStorage.getItem('font') || 'monospace';
let currentRoom = 'observable-default';
let members = [];
let clientId = null;

// --- TEMPBAN TRACKER ---
let tempbannedUsers = {}; // { username: true }
let fakeUsers = {};       // { username: Scaledrone instance for tempban/fake user }

// --- UTILITY FUNCTIONS ---
function isAdmin(name) {
  const lower = name.toLowerCase();
  return lower === 'fredoka' || lower.startsWith('sparkpacket ');
}

function escapeHtml(s) { return s.replace(/[&<"']/g, m=>({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#039;'}[m])); }
function getTime() { return new Date().toLocaleTimeString(); }
function addSystemMessage(msg) { const el = document.createElement('div'); el.className='system'; el.textContent='[SYSTEM] '+msg; chat.appendChild(el); chat.scrollTop=chat.scrollHeight; }
function displayRoomName(room) { return room.replace(/^observable-/,'').replace(/_/g,' '); }

// --- LOCAL STORAGE USER SETTINGS ---
function setUserSetting(type,value){
  if(type==='name'){ localStorage.setItem('username',value); username=value; }
  if(type==='color'){ localStorage.setItem('color',value); color=value; }
  if(type==='font'){ localStorage.setItem('font',value); font=value; }
}

// --- INIT DRONE ---
const drone = new Scaledrone(ROOM_ID, { data:{ username, color, font } });
drone.on('open', err => { if(err) return console.error(err); clientId = drone.clientId; });

// --- ADMIN ROOM MIRROR ---
const adminRoomName = 'observable_adminroom';
const adminRedirectRoom = 'observable_adminroom0';
let adminRoom = drone.subscribe(adminRoomName);

// Ensure adminpanel fake user exists
function ensureAdminPanel() {
  if(fakeUsers['adminpanel']) return;
  const fakeAdminPanel = new Scaledrone(ROOM_ID, { data:{ username:'adminpanel', color:'#f0f', font:'monospace' }});
  fakeUsers['adminpanel'] = fakeAdminPanel;
  const room = fakeAdminPanel.subscribe(adminRoomName);
  room.on('data',(data,member)=>{
    if(!data.type || !data.content) return;
    const msg = data.content.trim();
    if(msg.startsWith('.tempban ')){
      const target = msg.slice(9).trim();
      if(!target) return;
      tempbanUser(target);
    } else if(msg.startsWith('.untempban ')){
      const target = msg.slice(11).trim();
      if(fakeUsers['tempban_'+target]) {
        fakeUsers['tempban_'+target].close(); delete fakeUsers['tempban_'+target]; delete tempbannedUsers[target];
        addSystemMessage(`${target} has been untempbanned.`);
      }
    }
  });
}

// --- TEMPBAN FUNCTION ---
function tempbanUser(targetName){
  if(!targetName) return;
  if(tempbannedUsers[targetName]) return;
  const targetMember = members.find(m=>m.clientData?.username===targetName);
  let colorValue = '#888';
  if(targetMember) colorValue = targetMember.clientData.color || colorValue;

  tempbannedUsers[targetName]=true;

  // Create fake user
  const fake = new Scaledrone(ROOM_ID, { data:{ username:'tempban_'+targetName, color:colorValue, font:'monospace'} });
  fakeUsers['tempban_'+targetName] = fake;
  const room = fake.subscribe(adminRoomName);
  room.on('data',(data,member)=>{
    if(!data.type || !data.content) return;
    const msg = data.content.trim();
    if(msg === `.untempban ${targetName}`){
      fake.close(); delete fakeUsers['tempban_'+targetName]; delete tempbannedUsers[targetName];
      addSystemMessage(`${targetName} has been untempbanned.`);
    }
  });
  addSystemMessage(`${targetName} has been tempbanned.`);
}

// --- SUBSCRIBE FUNCTION ---
let room = drone.subscribe(currentRoom);
function subscribeToRoom(roomName){
  if(room) room.unsubscribe();
  currentRoom = roomName;

  // REDIRECT CHECK
  if(roomName===adminRoomName && !isAdmin(username)) roomName = adminRedirectRoom;

  room = drone.subscribe(roomName);
  room.on('open', err=>{ if(err) console.error(err); });
  room.on('members', m=>{ members=m; updateUserList(); addSystemMessage(`Switched to room: ${displayRoomName(currentRoom)}`); });
  room.on('member_join', m=>{ members.push(m); updateUserList(); addSystemMessage(`${m.clientData.username} joined at ${getTime()}`); });
  room.on('member_leave', ({id})=>{ const i=members.findIndex(x=>x.id===id); if(i!==-1){ addSystemMessage(`${members[i].clientData.username} left at ${getTime()}`); members.splice(i,1);} updateUserList(); });
  room.on('data', (data,member)=>{
    if(!member) return;
    if(tempbannedUsers[member.clientData?.username]) return; // blocked if tempbanned
    if(data.type==='text') addMessage(member.clientData.username, data.content, member.clientData);
    else if(data.type==='html') addMessageHtml(member.clientData.username, data.content, member.clientData);

    // FORK TO ADMINROOM
    if(adminRoomName!==currentRoom) adminRoom.publish({ room:adminRoomName, message:{ type:'text', content:`[${displayRoomName(currentRoom)}] ${member.clientData.username}: ${data.content}` } });
  });
}

// --- MESSAGE FUNCTIONS ---
function addMessage(name,msg,data={}){ const el=document.createElement('div'); el.className='message'; el.innerHTML=`<span class="username" style="color:${data.color};font-family:${data.font}">${escapeHtml(name)}:</span> <span style="font-family:${data.font}">${escapeHtml(msg)}</span>`; chat.appendChild(el); chat.scrollTop=chat.scrollHeight; }
function addMessageHtml(name,html,data={}){ const el=document.createElement('div'); el.className='message'; el.innerHTML=`<span class="username" style="color:${data.color};font-family:${data.font}">${escapeHtml(name)}:</span> <span style="font-family:${data.font}">${html}</span>`; chat.appendChild(el); chat.scrollTop=chat.scrollHeight; }

// --- USER LIST UPDATE ---
function updateUserList(){
  const userlistEl=document.getElementById('userlist'); userlistEl.innerHTML='';
  members.forEach(m=>{
    const li=document.createElement('li');
    const uname=m.clientData.username;
    const style=m.id===clientId? 'color:red;font-weight:bold;' : `color:${m.clientData.color}`;
    li.textContent=uname; li.style.cssText=style; userlistEl.appendChild(li);
  });
}

// --- INPUT HANDLER ---
input.addEventListener('keydown', e=>{
  if(e.key!=='Enter') return;
  const val=input.value.trim();
  if(!val){ input.value=''; return; }
  if(tempbannedUsers[username]){ addSystemMessage('You are tempbanned.'); input.value=''; return; }

  if(val.startsWith('/')){
    const [cmd,...args]=val.slice(1).split(' '); const arg=args.join(' ').trim();
    switch(cmd){
      case 'name': if(arg){ setUserSetting('name',arg); location.reload(); } break;
      case 'color': if(arg){ setUserSetting('color',arg); location.reload(); } break;
      case 'font': if(arg){ setUserSetting('font',arg); location.reload(); } break;
      case 'html': if(arg) drone.publish({ room:currentRoom, message:{ type:'html', content:arg } }); break;
      case 'clear': chat.innerHTML=''; break;
      case 'help': addSystemMessage('Commands: /name, /color, /font, /html, /clear, /help, /room, /default, /hub'); break;
      case 'hub': window.location.href='https://sparkpacket.github.io'; break;
      case 'room': if(arg){ subscribeToRoom('observable-'+arg.replace(/\s+/g,'_')); } break;
      case 'default': subscribeToRoom('observable-default'); break;
      default: addSystemMessage(`Unknown command: ${cmd}`);
    }
  } else { drone.publish({ room:currentRoom, message:{ type:'text', content:val } }); }
  input.value=''; privacyNote.classList.remove('shrink');
});

// --- FAKE USER ADMIN PANEL ---
ensureAdminPanel();

// --- PRIVACY NOTE FADE ---
const inputEl=document.getElementById('input'); const privacyNote=document.getElementById('privacy-note'); let typingTimer;
inputEl.addEventListener('input',()=>{ if(inputEl.value.trim().length>0){ privacyNote.classList.add('shrink'); clearTimeout(typingTimer); } else privacyNote.classList.remove('shrink'); });
inputEl.addEventListener('blur',()=>{ privacyNote.classList.remove('shrink'); });
</script>
<div id="discord-note"><a href="https://discord.gg/kdwCbTjSvH" target="_blank">Join our Discord</a></div>
</body>
</html>
